<?xml version="1.0"?>
<tool id="edu.tamu.cpt.sequencing.basespace-auth-2" name="BaseSpace Auth Part 2" version="1.1">
  <description></description>
  <command detect_errors="aggressive"><![CDATA[
CLIENT=`cat /galaxy/creds.json | jq .illumina_basespace.client_id -r`;
SECRET=`cat /galaxy/creds.json | jq .illumina_basespace.secret_id -r`;
DEVICE_CODE=`cat $device_code_file`;

TOKEN=`curl
	--silent
	-X POST
	-d"response_type=device_code"
	-d"client_id=\$CLIENT"
	-d"client_secret=\$SECRET"
	-d"code=\$DEVICE_CODE"
	-d"grant_type=device"
	https://api.basespace.illumina.com/v1pre3/oauthv2/token | jq .token -r`;

TMPFILE=`mktemp`;
cat /galaxy/creds.basespace.json |
	jq ".basespace.$__user_email__ = \$TOKEN" > \$TMPFILE;

mv \$TMPFILE /galaxy/creds.basespace.json;

echo "$__user_email__ = \$TOKEN" > $output;
]]></command>
  <inputs>
    <param type="data" format="txt" name="device_code_file" label="Device Code File" />
  </inputs>
  <outputs>
    <data format="txt" name="output" label="Device Code" />
  </outputs>
  <tests>
  </tests>
  <help><![CDATA[
**How it works**

This tool completes the authentication process and stores your token in
the token store. This permits you to run the basespace tools.

]]></help>
  <expand macro="citations" />
</tool>
